---
title: "Panicum hallii microbiome"
output: html_notebook
---

```{r}
library(tidyverse)
library(tidyMB)
```

```{r}
ct <- readRDS("~/SMB/Albina/2017 Spring Microbiome seq/PH_Analysis/count_table.rds") %>% 
  t() %>% as.data.frame() %>% rownames_to_column("sequence") %>% as_tibble()
taxa <- readRDS("~/SMB/Albina/2017 Spring Microbiome seq/PH_Analysis/taxa.rds") %>% 
  as.data.frame() %>% rownames_to_column("sequence") %>% as_tibble()
map <- read.table("~/SMB/Albina/2017 Spring Microbiome seq/PH_Analysis/map.txt") %>% 
  mutate(SampleID = gsub("\\.fastq\\.gz", "", V2))
```

```{r}
ph_data <- ct %>% 
  gather(SampleID, value, -sequence) %>% 
  inner_join(taxa, by = "sequence") %>% 
  inner_join(map, by = "SampleID") %>% 
  filter(Family != "Mitochondria" & Order != "Chloroplast" & Kingdom != "Eukaryota") %>% 
  group_by(SampleID) %>% 
  mutate(depth = sum(value), RA = value / depth) %>% 
  mutate(Phylum2 = NA) %>% 
  mutate(Phylum2 = ifelse(Phylum == "Proteobacteria", as.character(Class), as.character(Phylum)))
```


```{r}
ph_data %>% 
  filter(V1)
  group_by(SampleID, Phylum2) %>% 
  summarise(phy_total = sum(RA)) %>% 
  group_by(Phylum2) %>% 
  nest() %>% 
  mutate(total = map_dbl(data, ~sum(.x$phy_total, na.rm = T))) %>% 
  top_n(10, total) %>% 
  unnest(data) %>% 
  ggplot(aes(SampleID, phy_total, fill = Phylum2)) +
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Spectral")
```


